---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { isAuthenticated } from '../../../lib/auth';

const auth = await isAuthenticated(Astro);
if (!auth.authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Media Library">
  <div class="media-page">
    <div class="page-header">
      <div>
        <h1>Media Library</h1>
        <p>Upload and manage your images</p>
      </div>
      <button type="button" id="upload-btn" class="btn-primary">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Upload
      </button>
    </div>

    <div class="toolbar">
      <input type="text" id="search" placeholder="Search images..." />
      <select id="sort">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="name">Name</option>
        <option value="size">Size</option>
      </select>
      <button type="button" id="refresh" class="btn-secondary">Refresh</button>
    </div>

    <div id="gallery" class="gallery">
      <div class="loading">
        <div class="spinner"></div>
        <span>Loading...</span>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <h2>Upload Images</h2>
        <button type="button" class="close-btn">&times;</button>
      </div>
      <div class="modal-content">
        <div id="dropzone" class="dropzone">
          <input type="file" id="file-input" accept="image/*" multiple hidden />
          <label for="file-input">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <span>Drop images here or click to browse</span>
            <small>JPG, PNG, GIF, WebP ‚Ä¢ Max 10MB</small>
          </label>
        </div>
        <div id="upload-list"></div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-box modal-large">
      <div class="modal-head">
        <h2>Edit Image</h2>
        <button type="button" class="close-btn">&times;</button>
      </div>
      <div class="modal-content">
        <div class="edit-grid">
          <div class="edit-preview">
            <img id="edit-img" src="" alt="" />
          </div>
          <div class="edit-panel">
            <div class="panel-section">
              <h3>Resize</h3>
              <div class="size-row">
                <label>
                  W: <input type="number" id="img-width" min="1" />
                </label>
                <button type="button" id="lock-btn" class="lock active">üîó</button>
                <label>
                  H: <input type="number" id="img-height" min="1" />
                </label>
              </div>
              <div class="presets">
                <button data-w="1920" data-h="1080">1920√ó1080</button>
                <button data-w="1280" data-h="720">1280√ó720</button>
                <button data-w="800" data-h="600">800√ó600</button>
                <button data-w="400" data-h="300">400√ó300</button>
              </div>
            </div>

            <div class="panel-section">
              <h3>Filters</h3>
              <div class="filter-row">
                <button class="filter-btn active" data-filter="none">None</button>
                <button class="filter-btn" data-filter="grayscale(100%)">B&W</button>
                <button class="filter-btn" data-filter="sepia(100%)">Sepia</button>
                <button class="filter-btn" data-filter="contrast(120%) saturate(120%)">Vivid</button>
                <button class="filter-btn" data-filter="brightness(90%) contrast(110%)">Dark</button>
                <button class="filter-btn" data-filter="brightness(110%) saturate(80%)">Fade</button>
              </div>
            </div>

            <div class="panel-section">
              <h3>Adjust</h3>
              <label class="slider-row">
                <span>Brightness</span>
                <input type="range" id="brightness" min="50" max="150" value="100" />
                <span class="val">100%</span>
              </label>
              <label class="slider-row">
                <span>Contrast</span>
                <input type="range" id="contrast" min="50" max="150" value="100" />
                <span class="val">100%</span>
              </label>
              <label class="slider-row">
                <span>Saturate</span>
                <input type="range" id="saturate" min="0" max="200" value="100" />
                <span class="val">100%</span>
              </label>
              <label class="slider-row">
                <span>Blur</span>
                <input type="range" id="blur" min="0" max="10" value="0" />
                <span class="val">0px</span>
              </label>
            </div>

            <div class="panel-actions">
              <button type="button" id="reset-btn" class="btn-secondary">Reset</button>
              <button type="button" id="apply-btn" class="btn-primary">Apply Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="info-modal" class="modal">
    <div class="modal-box">
      <div class="modal-head">
        <h2>Image Details</h2>
        <button type="button" class="close-btn">&times;</button>
      </div>
      <div class="modal-content">
        <img id="info-img" src="" alt="" class="info-preview" />
        <div class="info-rows">
          <div class="info-row">
            <span>URL</span>
            <input type="text" id="info-url" readonly />
            <button type="button" class="copy-btn" data-target="info-url">Copy</button>
          </div>
          <div class="info-row">
            <span>Size</span>
            <span id="info-size">-</span>
          </div>
          <div class="info-row">
            <span>Dimensions</span>
            <span id="info-dims">-</span>
          </div>
        </div>
        <div class="info-actions">
          <button type="button" id="open-editor" class="btn-primary">Edit Image</button>
          <button type="button" id="delete-btn" class="btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  /* Base */
  .media-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .page-header h1 {
    margin: 0;
    font-size: 1.5rem;
  }

  .page-header p {
    margin: 0.25rem 0 0;
    color: #666;
    font-size: 0.875rem;
  }

  /* Buttons */
  .btn-primary, .btn-secondary, .btn-danger {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary {
    background: #3b82f6;
    color: white;
  }

  .btn-primary:hover {
    background: #2563eb;
  }

  .btn-secondary {
    background: #f1f5f9;
    color: #334155;
    border: 1px solid #e2e8f0;
  }

  .btn-secondary:hover {
    background: #e2e8f0;
  }

  .btn-danger {
    background: #ef4444;
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .toolbar input, .toolbar select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.875rem;
    background: white;
  }

  .toolbar input {
    flex: 1;
    min-width: 200px;
  }

  /* Gallery Grid - FIXED */
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
  }

  .gallery-item {
    position: relative;
    background: #f8fafc;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.2s, transform 0.2s;
  }

  .gallery-item:hover {
    border-color: #3b82f6;
    transform: translateY(-2px);
  }

  /* FIXED: Image container with fixed aspect ratio */
  .thumb-wrapper {
    position: relative;
    width: 100%;
    padding-top: 75%; /* 4:3 aspect ratio */
    background: #e2e8f0;
    overflow: hidden;
  }

  .thumb-wrapper img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .item-info {
    padding: 0.625rem;
  }

  .item-name {
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .item-meta {
    font-size: 0.625rem;
    color: #94a3b8;
    margin-top: 0.25rem;
  }

  .item-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .gallery-item:hover .item-actions {
    opacity: 1;
  }

  .item-actions button {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 4px;
    background: rgba(255,255,255,0.9);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
  }

  .item-actions button:hover {
    background: #3b82f6;
    color: white;
  }

  /* Loading */
  .loading {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 4rem;
    color: #64748b;
  }

  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 0.75rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    padding: 1rem;
    overflow-y: auto;
  }

  .modal.open {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 5vh;
  }

  .modal-box {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-large {
    max-width: 900px;
  }

  .modal-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .modal-head h2 {
    margin: 0;
    font-size: 1.125rem;
  }

  .close-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    font-size: 1.5rem;
    color: #64748b;
    cursor: pointer;
    border-radius: 4px;
  }

  .close-btn:hover {
    background: #f1f5f9;
  }

  .modal-content {
    padding: 1.25rem;
    overflow-y: auto;
  }

  /* Dropzone */
  .dropzone {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s;
  }

  .dropzone.dragover {
    border-color: #3b82f6;
    background: #eff6ff;
  }

  .dropzone label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: #64748b;
  }

  .dropzone svg {
    color: #3b82f6;
  }

  .dropzone small {
    font-size: 0.75rem;
    color: #94a3b8;
  }

  #upload-list {
    margin-top: 1rem;
  }

  .upload-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    background: #f8fafc;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .upload-item .progress {
    flex: 1;
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    overflow: hidden;
  }

  .upload-item .progress-bar {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s;
  }

  /* Edit Modal */
  .edit-grid {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 1.25rem;
  }

  .edit-preview {
    background: #f1f5f9;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    overflow: hidden;
  }

  .edit-preview img {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
  }

  .edit-panel {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .panel-section {
    background: #f8fafc;
    padding: 0.875rem;
    border-radius: 8px;
  }

  .panel-section h3 {
    margin: 0 0 0.75rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #475569;
  }

  .size-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .size-row label {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
  }

  .size-row input {
    width: 70px;
    padding: 0.375rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 0.75rem;
  }

  .lock {
    width: 28px;
    height: 28px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 0.75rem;
  }

  .lock.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .presets {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.5rem;
  }

  .presets button {
    padding: 0.25rem 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: white;
    font-size: 0.625rem;
    cursor: pointer;
  }

  .presets button:hover {
    border-color: #3b82f6;
    color: #3b82f6;
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .filter-btn {
    padding: 0.375rem 0.625rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: white;
    font-size: 0.6875rem;
    cursor: pointer;
  }

  .filter-btn.active, .filter-btn:hover {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .slider-row {
    display: grid;
    grid-template-columns: 70px 1fr 40px;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
  }

  .slider-row input[type="range"] {
    width: 100%;
    height: 4px;
    -webkit-appearance: none;
    background: #e2e8f0;
    border-radius: 2px;
  }

  .slider-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: #3b82f6;
    border-radius: 50%;
    cursor: pointer;
  }

  .slider-row .val {
    text-align: right;
    color: #64748b;
  }

  .panel-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .panel-actions button {
    flex: 1;
  }

  /* Info Modal */
  .info-preview {
    width: 100%;
    max-height: 250px;
    object-fit: contain;
    border-radius: 8px;
    background: #f1f5f9;
    margin-bottom: 1rem;
  }

  .info-rows {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .info-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .info-row > span:first-child {
    width: 80px;
    color: #64748b;
    font-size: 0.75rem;
  }

  .info-row input {
    flex: 1;
    padding: 0.375rem 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 0.8125rem;
    background: #f8fafc;
  }

  .copy-btn {
    padding: 0.375rem 0.625rem;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: white;
    font-size: 0.75rem;
    cursor: pointer;
  }

  .copy-btn:hover {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }

  .info-actions {
    display: flex;
    gap: 0.5rem;
  }

  .info-actions button {
    flex: 1;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .media-page {
      padding: 1rem;
    }

    .gallery {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .edit-grid {
      grid-template-columns: 1fr;
    }

    .modal-large {
      max-width: 100%;
    }
  }
</style>

<script>
  let images = [];
  let selectedImage = null;
  let aspectLocked = true;
  let originalRatio = 1;

  const gallery = document.getElementById('gallery');
  const search = document.getElementById('search');
  const sort = document.getElementById('sort');

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadImages();
    setupModals();
    setupUpload();
    setupEditor();
  });

  // Load images
  async function loadImages() {
    gallery.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading...</span></div>';

    try {
      const res = await fetch('/admin/api/list-images.json');
      const data = await res.json();

      if (data.success && data.images) {
        images = data.images;
        renderGallery();
      } else {
        gallery.innerHTML = '<div class="empty-state">No images found</div>';
      }
    } catch (err) {
      console.error(err);
      gallery.innerHTML = '<div class="empty-state">Failed to load images</div>';
    }
  }

  // Render gallery
  function renderGallery() {
    let list = [...images];

    // Filter
    const q = search.value.toLowerCase();
    if (q) {
      list = list.filter(img => (img.name || img.filename || '').toLowerCase().includes(q));
    }

    // Sort
    const s = sort.value;
    list.sort((a, b) => {
      if (s === 'newest') return new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0);
      if (s === 'oldest') return new Date(a.uploadDate || 0) - new Date(b.uploadDate || 0);
      if (s === 'name') return (a.name || '').localeCompare(b.name || '');
      if (s === 'size') return (b.size || 0) - (a.size || 0);
      return 0;
    });

    if (list.length === 0) {
      gallery.innerHTML = '<div class="empty-state">No images found</div>';
      return;
    }

    gallery.innerHTML = list.map(img => `
      <div class="gallery-item" data-id="${img.id || img.key}">
        <div class="thumb-wrapper">
          <img src="${img.url}" alt="${img.name || ''}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e2e8f0%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-size=%2212%22>No image</text></svg>'" />
        </div>
        <div class="item-info">
          <div class="item-name">${img.name || img.filename || 'Untitled'}</div>
          <div class="item-meta">${formatSize(img.size)}</div>
        </div>
        <div class="item-actions">
          <button data-action="edit" title="Edit">‚úèÔ∏è</button>
          <button data-action="copy" title="Copy URL">üìã</button>
        </div>
      </div>
    `).join('');

    // Events
    gallery.querySelectorAll('.gallery-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const id = item.dataset.id;
        const img = images.find(i => (i.id || i.key) === id);
        if (!img) return;

        const action = e.target.closest('[data-action]')?.dataset.action;
        if (action === 'edit') {
          e.stopPropagation();
          openEditor(img);
        } else if (action === 'copy') {
          e.stopPropagation();
          navigator.clipboard.writeText(img.url);
          e.target.textContent = '‚úì';
          setTimeout(() => e.target.textContent = 'üìã', 1000);
        } else {
          openInfo(img);
        }
      });
    });
  }

  // Modals
  function setupModals() {
    document.querySelectorAll('.close-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.closest('.modal').classList.remove('open');
      });
    });

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('open');
      });
    });

    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('upload-modal').classList.add('open');
    });

    document.getElementById('refresh').addEventListener('click', loadImages);
    search.addEventListener('input', renderGallery);
    sort.addEventListener('change', renderGallery);

    // Info modal
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const input = document.getElementById(btn.dataset.target);
        navigator.clipboard.writeText(input.value);
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 1000);
      });
    });

    document.getElementById('open-editor').addEventListener('click', () => {
      document.getElementById('info-modal').classList.remove('open');
      if (selectedImage) openEditor(selectedImage);
    });

    document.getElementById('delete-btn').addEventListener('click', deleteImage);
  }

  // Upload
  function setupUpload() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const uploadList = document.getElementById('upload-list');

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('image/'));
      uploadFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      uploadFiles([...e.target.files]);
      e.target.value = '';
    });

    async function uploadFiles(files) {
      for (const file of files) {
        const item = document.createElement('div');
        item.className = 'upload-item';
        item.innerHTML = `
          <span>${file.name}</span>
          <div class="progress"><div class="progress-bar" style="width: 0%"></div></div>
          <span class="status">...</span>
        `;
        uploadList.appendChild(item);

        const bar = item.querySelector('.progress-bar');
        const status = item.querySelector('.status');

        try {
          bar.style.width = '30%';
          const formData = new FormData();
          formData.append('image', file);

          const res = await fetch('/admin/api/upload-image.json', {
            method: 'POST',
            body: formData
          });

          bar.style.width = '100%';

          if (res.ok) {
            status.textContent = '‚úì';
            status.style.color = '#22c55e';
          } else {
            status.textContent = '‚úó';
            status.style.color = '#ef4444';
          }
        } catch {
          status.textContent = '‚úó';
          status.style.color = '#ef4444';
        }
      }

      setTimeout(() => {
        uploadList.innerHTML = '';
        loadImages();
      }, 1500);
    }
  }

  // Info modal
  function openInfo(img) {
    selectedImage = img;
    document.getElementById('info-img').src = img.url;
    document.getElementById('info-url').value = img.url;
    document.getElementById('info-size').textContent = formatSize(img.size);

    const imgEl = new Image();
    imgEl.onload = () => {
      document.getElementById('info-dims').textContent = `${imgEl.width} √ó ${imgEl.height}`;
    };
    imgEl.src = img.url;

    document.getElementById('info-modal').classList.add('open');
  }

  // Delete
  async function deleteImage() {
    if (!selectedImage || !confirm('Delete this image?')) return;

    try {
      const res = await fetch('/admin/api/delete-image.json', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: selectedImage.filename || selectedImage.key })
      });

      if (res.ok) {
        document.getElementById('info-modal').classList.remove('open');
        loadImages();
      } else {
        alert('Failed to delete');
      }
    } catch {
      alert('Error deleting image');
    }
  }

  // Editor
  function setupEditor() {
    const lockBtn = document.getElementById('lock-btn');
    const widthInput = document.getElementById('img-width');
    const heightInput = document.getElementById('img-height');

    lockBtn.addEventListener('click', () => {
      aspectLocked = !aspectLocked;
      lockBtn.classList.toggle('active', aspectLocked);
    });

    widthInput.addEventListener('input', () => {
      if (aspectLocked && originalRatio) {
        heightInput.value = Math.round(widthInput.value / originalRatio);
      }
    });

    heightInput.addEventListener('input', () => {
      if (aspectLocked && originalRatio) {
        widthInput.value = Math.round(heightInput.value * originalRatio);
      }
    });

    document.querySelectorAll('.presets button').forEach(btn => {
      btn.addEventListener('click', () => {
        widthInput.value = btn.dataset.w;
        heightInput.value = btn.dataset.h;
      });
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
      });
    });

    ['brightness', 'contrast', 'saturate', 'blur'].forEach(name => {
      const slider = document.getElementById(name);
      slider.addEventListener('input', () => {
        const val = slider.parentElement.querySelector('.val');
        val.textContent = name === 'blur' ? `${slider.value}px` : `${slider.value}%`;
        applyFilters();
      });
    });

    document.getElementById('reset-btn').addEventListener('click', resetEditor);
    document.getElementById('apply-btn').addEventListener('click', () => {
      alert('Image processing coming soon!');
    });
  }

  function openEditor(img) {
    selectedImage = img;
    const editImg = document.getElementById('edit-img');
    editImg.src = img.url;

    const imgEl = new Image();
    imgEl.onload = () => {
      document.getElementById('img-width').value = imgEl.width;
      document.getElementById('img-height').value = imgEl.height;
      originalRatio = imgEl.width / imgEl.height;
    };
    imgEl.src = img.url;

    resetEditor();
    document.getElementById('edit-modal').classList.add('open');
  }

  function resetEditor() {
    document.getElementById('brightness').value = 100;
    document.getElementById('contrast').value = 100;
    document.getElementById('saturate').value = 100;
    document.getElementById('blur').value = 0;

    document.querySelectorAll('.slider-row .val').forEach((v, i) => {
      v.textContent = i === 3 ? '0px' : '100%';
    });

    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.filter-btn[data-filter="none"]').classList.add('active');

    applyFilters();
  }

  function applyFilters() {
    const brightness = document.getElementById('brightness').value;
    const contrast = document.getElementById('contrast').value;
    const saturate = document.getElementById('saturate').value;
    const blur = document.getElementById('blur').value;
    const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'none';

    let filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturate}%) blur(${blur}px)`;
    if (activeFilter !== 'none') {
      filter += ` ${activeFilter}`;
    }

    document.getElementById('edit-img').style.filter = filter;
  }

  function formatSize(bytes) {
    if (!bytes) return '-';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
  }
</script>
