---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { isAuthenticated } from '../../../lib/auth';

// Check authentication
const auth = await isAuthenticated(Astro);
if (!auth.authenticated) {
  return Astro.redirect('/admin/login');
}
---

<AdminLayout title="Media Library">
  <div class="media-library">
    <header class="media-header">
      <div class="header-content">
        <h1>Media Library</h1>
        <p>Manage your uploaded images and media files</p>
      </div>
      <div class="header-actions">
        <button type="button" id="upload-btn" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Upload Images
        </button>
      </div>
    </header>

    <div class="media-filters">
      <div class="filter-group">
        <input type="text" id="search-input" placeholder="Search images..." class="search-input" />
        <select id="sort-select" class="sort-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="name">Name A-Z</option>
          <option value="size">File Size</option>
        </select>
        <button type="button" id="refresh-btn" class="btn btn-secondary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
          </svg>
          Refresh
        </button>
      </div>
      <div class="view-options">
        <button type="button" id="grid-view" class="view-btn active" title="Grid View">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </button>
        <button type="button" id="list-view" class="view-btn" title="List View">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <div id="media-grid" class="media-grid">
      <div class="loading-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <p>Loading images...</p>
      </div>
    </div>

    <div id="media-list" class="media-list" style="display: none;">
      <div class="list-header">
        <div class="col-image">Image</div>
        <div class="col-name">Name</div>
        <div class="col-size">Size</div>
        <div class="col-date">Upload Date</div>
        <div class="col-actions">Actions</div>
      </div>
      <div id="list-content" class="list-content">
        <!-- List items will be populated here -->
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upload Images</h2>
        <button type="button" class="modal-close">×</button>
      </div>
      <div class="modal-body">
        <div class="upload-area" id="upload-area">
          <input type="file" id="file-input" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" multiple />
          <label for="file-input" class="upload-label">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Choose files or drag here</span>
            <small>JPG, PNG, GIF, WebP up to 10MB each</small>
          </label>
        </div>
        <div id="upload-progress" class="upload-progress"></div>
      </div>
    </div>
  </div>

  <!-- Image Details Modal -->
  <div id="details-modal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Image Details</h2>
        <button type="button" class="modal-close">×</button>
      </div>
      <div class="modal-body">
        <div class="image-details">
          <div class="image-preview-large">
            <img id="preview-image" src="" alt="" />
          </div>
          <div class="image-info">
            <div class="info-group">
              <label>File Name:</label>
              <input type="text" id="detail-filename" class="form-input" readonly />
              <button type="button" id="copy-filename" class="copy-btn" title="Copy filename">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
            
            <div class="info-group">
              <label>Public URL:</label>
              <input type="text" id="detail-url" class="form-input" readonly />
              <button type="button" id="copy-url" class="copy-btn" title="Copy URL">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
            
            <div class="info-group">
              <label>File Size:</label>
              <span id="detail-size"></span>
            </div>
            
            <div class="info-group">
              <label>Upload Date:</label>
              <span id="detail-date"></span>
            </div>
            
            <div class="info-group">
              <label>Dimensions:</label>
              <span id="detail-dimensions">Loading...</span>
            </div>
            
            <div class="detail-actions">
              <button type="button" id="insert-image" class="btn btn-primary">
                Insert into Editor
              </button>
              <button type="button" id="delete-image" class="btn btn-danger">
                Delete Image
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .media-library {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .media-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .header-content h1 {
    margin: 0 0 0.5rem;
    font-size: 2rem;
    font-weight: 700;
  }

  .header-content p {
    margin: 0;
    color: var(--color-text-muted);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-secondary {
    background: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-danger {
    background: var(--color-error);
    color: white;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .media-filters {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--color-surface);
    border-radius: var(--radius-lg);
  }

  .filter-group {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .search-input,
  .sort-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .search-input {
    min-width: 250px;
  }

  .view-options {
    display: flex;
    gap: 0.5rem;
  }

  .view-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text);
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .view-btn.active {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  .media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .media-item {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-base);
    cursor: pointer;
    border: 2px solid transparent;
  }

  .media-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    border-color: var(--color-primary);
  }

  .media-thumbnail {
    position: relative;
    aspect-ratio: 16/9;
    overflow: hidden;
    background: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .media-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
    display: block;
  }

  .media-item:hover .media-thumbnail img {
    transform: scale(1.05);
  }

  .media-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .media-item:hover .media-overlay {
    opacity: 1;
  }

  .media-actions {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: var(--radius-md);
    background: white;
    color: var(--color-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
  }

  .action-btn:hover {
    background: var(--color-primary);
    color: white;
  }

  .media-info {
    padding: 1rem;
  }

  .media-name {
    font-weight: 600;
    margin: 0 0 0.25rem;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .media-meta {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    display: flex;
    justify-content: space-between;
  }

  .media-list {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .list-header {
    display: grid;
    grid-template-columns: 80px 1fr 120px 150px 120px;
    gap: 1rem;
    padding: 1rem;
    background: var(--color-background);
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
  }

  .list-content {
    max-height: 600px;
    overflow-y: auto;
  }

  .list-item {
    display: grid;
    grid-template-columns: 80px 1fr 120px 150px 120px;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
    align-items: center;
    transition: background var(--transition-base);
    cursor: pointer;
  }

  .list-item:hover {
    background: var(--color-background);
  }

  .list-thumbnail {
    width: 60px;
    height: 40px;
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .list-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .loading-state {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    color: var(--color-text-muted);
  }

  .loading-state svg {
    margin-bottom: 1rem;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    padding: 2rem;
  }

  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-large {
    max-width: 900px;
  }

  .modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    color: var(--color-text-muted);
    cursor: pointer;
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
  }

  .upload-area {
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    text-align: center;
    margin-bottom: 1.5rem;
    transition: all var(--transition-base);
  }

  .upload-area.drag-over {
    border-color: var(--color-primary);
    background: var(--color-primary-alpha-10);
  }

  .upload-area input[type="file"] {
    display: none;
  }

  .upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-muted);
    cursor: pointer;
  }

  .upload-label small {
    font-size: 0.75rem;
    opacity: 0.7;
  }

  .upload-progress {
    margin-top: 1rem;
  }

  .progress-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: 0.5rem;
  }

  .progress-bar {
    flex: 1;
    height: 6px;
    background: var(--color-surface);
    border-radius: var(--radius-full);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width var(--transition-base);
  }

  .image-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  .image-preview-large {
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-background);
  }

  .image-preview-large img {
    width: 100%;
    height: auto;
    display: block;
  }

  .image-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .info-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .info-group label {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-text);
  }

  .info-group > div {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .form-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .copy-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text);
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .copy-btn:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  .detail-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  @media (max-width: 768px) {
    .media-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .media-filters {
      flex-direction: column;
      gap: 1rem;
    }

    .filter-group {
      width: 100%;
      justify-content: space-between;
    }

    .search-input {
      min-width: 200px;
    }

    .media-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }

    .list-header,
    .list-item {
      grid-template-columns: 60px 1fr 80px;
      gap: 0.5rem;
    }

    .col-size,
    .col-date {
      display: none;
    }

    .image-details {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // State management
  let images = [];
  let filteredImages = [];
  let currentView = 'grid';
  let selectedImage = null;

  // DOM elements
  const uploadBtn = document.getElementById('upload-btn');
  const uploadModal = document.getElementById('upload-modal');
  const detailsModal = document.getElementById('details-modal');
  const fileInput = document.getElementById('file-input');
  const uploadArea = document.getElementById('upload-area');
  const uploadProgress = document.getElementById('upload-progress');
  const mediaGrid = document.getElementById('media-grid');
  const mediaList = document.getElementById('media-list');
  const searchInput = document.getElementById('search-input');
  const sortSelect = document.getElementById('sort-select');
  const refreshBtn = document.getElementById('refresh-btn');
  const gridViewBtn = document.getElementById('grid-view');
  const listViewBtn = document.getElementById('list-view');

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadImages();
    setupEventListeners();
  });

  function setupEventListeners() {
    // Upload modal
    uploadBtn?.addEventListener('click', () => {
      uploadModal.classList.add('active');
    });

    // Modal close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.target.closest('.modal').classList.remove('active');
      });
    });

    // Click outside modal to close
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });

    // File upload
    fileInput?.addEventListener('change', handleFileUpload);

    // Drag and drop
    uploadArea?.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea?.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
    });

    uploadArea?.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
      if (files.length > 0) {
        uploadFiles(files);
      }
    });

    // Search and filters
    searchInput?.addEventListener('input', filterImages);
    sortSelect?.addEventListener('change', filterImages);
    refreshBtn?.addEventListener('click', loadImages);

    // View toggle
    gridViewBtn?.addEventListener('click', () => setView('grid'));
    listViewBtn?.addEventListener('click', () => setView('list'));

    // Copy buttons in details modal
    document.getElementById('copy-filename')?.addEventListener('click', () => {
      copyToClipboard(document.getElementById('detail-filename').value);
    });

    document.getElementById('copy-url')?.addEventListener('click', () => {
      copyToClipboard(document.getElementById('detail-url').value);
    });

    // Delete image
    document.getElementById('delete-image')?.addEventListener('click', deleteSelectedImage);

    // Insert image
    document.getElementById('insert-image')?.addEventListener('click', insertSelectedImage);
  }

  async function loadImages() {
    try {
      mediaGrid.innerHTML = '<div class="loading-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><p>Loading images...</p></div>';
      
      const response = await fetch('/admin/api/list-images.json');
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.success) {
        images = data.images || [];
        filteredImages = [...images];
        filterImages(); // Apply current filters and render
      } else {
        throw new Error(data.error || 'Failed to load images');
      }
      
      if (images.length === 0) {
        mediaGrid.innerHTML = '<div class="loading-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg><p>No images found. Upload some images to get started!</p></div>';
      }
      
    } catch (error) {
      console.error('Error loading images:', error);
      mediaGrid.innerHTML = '<div class="loading-state"><p>Error loading images. Please try again.</p></div>';
    }
  }

  function handleFileUpload(e) {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
      uploadFiles(files);
    }
    e.target.value = ''; // Clear input
  }

  async function uploadFiles(files) {
    uploadProgress.innerHTML = '';
    
    for (const file of files) {
      await uploadSingleFile(file);
    }
    
    // Refresh the image list after uploads
    setTimeout(() => {
      loadImages();
    }, 1000);
  }

  async function uploadSingleFile(file) {
    const progressItem = document.createElement('div');
    progressItem.className = 'progress-item';
    progressItem.innerHTML = `
      <span>${file.name}</span>
      <div class="progress-bar">
        <div class="progress-fill" style="width: 0%"></div>
      </div>
      <span class="progress-status">Uploading...</span>
    `;
    uploadProgress.appendChild(progressItem);
    
    const progressFill = progressItem.querySelector('.progress-fill');
    const progressStatus = progressItem.querySelector('.progress-status');
    
    const formData = new FormData();
    formData.append('image', file);
    
    try {
      progressFill.style.width = '30%';
      
      const response = await fetch('/admin/api/upload-image.json', {
        method: 'POST',
        body: formData
      });
      
      progressFill.style.width = '90%';
      
      if (response.ok) {
        const data = await response.json();
        progressFill.style.width = '100%';
        progressStatus.textContent = 'Complete';
        progressStatus.style.color = 'var(--color-success)';
        
        setTimeout(() => {
          progressItem.remove();
        }, 2000);
      } else {
        const errorData = await response.json();
        progressStatus.textContent = `Error: ${errorData.error}`;
        progressStatus.style.color = 'var(--color-error)';
      }
    } catch (error) {
      progressStatus.textContent = `Error: ${error.message}`;
      progressStatus.style.color = 'var(--color-error)';
    }
  }

  function filterImages() {
    const searchTerm = searchInput.value.toLowerCase();
    const sortBy = sortSelect.value;
    
    filteredImages = images.filter(image => 
      image.name.toLowerCase().includes(searchTerm)
    );
    
    // Sort images
    filteredImages.sort((a, b) => {
      switch (sortBy) {
        case 'newest':
          return new Date(b.uploadDate) - new Date(a.uploadDate);
        case 'oldest':
          return new Date(a.uploadDate) - new Date(b.uploadDate);
        case 'name':
          return a.name.localeCompare(b.name);
        case 'size':
          return b.size - a.size;
        default:
          return 0;
      }
    });
    
    renderImages();
  }

  function renderImages() {
    if (currentView === 'grid') {
      renderGridView();
    } else {
      renderListView();
    }
  }

  function renderGridView() {
    if (filteredImages.length === 0) {
      mediaGrid.innerHTML = '<div class="loading-state"><p>No images found.</p></div>';
      return;
    }
    
    mediaGrid.innerHTML = filteredImages.map(image => `
      <div class="media-item" onclick="showImageDetails('${image.id}')">
        <div class="media-thumbnail">
          <img src="${image.url}" alt="${image.name}" loading="lazy" />
          <div class="media-overlay">
            <div class="media-actions">
              <button class="action-btn" onclick="event.stopPropagation(); copyToClipboard('${image.url}')" title="Copy URL">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
              <button class="action-btn" onclick="event.stopPropagation(); deleteImage('${image.id}')" title="Delete">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="media-info">
          <div class="media-name">${image.name}</div>
          <div class="media-meta">
            <span>${formatFileSize(image.size)}</span>
            <span>${formatDate(image.uploadDate)}</span>
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderListView() {
    const listContent = document.getElementById('list-content');
    
    if (filteredImages.length === 0) {
      listContent.innerHTML = '<div class="loading-state"><p>No images found.</p></div>';
      return;
    }
    
    listContent.innerHTML = filteredImages.map(image => `
      <div class="list-item" onclick="showImageDetails('${image.id}')">
        <div class="list-thumbnail">
          <img src="${image.url}" alt="${image.name}" loading="lazy" />
        </div>
        <div class="media-name">${image.name}</div>
        <div class="col-size">${formatFileSize(image.size)}</div>
        <div class="col-date">${formatDate(image.uploadDate)}</div>
        <div class="col-actions">
          <button class="action-btn" onclick="event.stopPropagation(); copyToClipboard('${image.url}')" title="Copy URL">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>
      </div>
    `).join('');
  }

  function setView(view) {
    currentView = view;
    
    // Update button states
    gridViewBtn.classList.toggle('active', view === 'grid');
    listViewBtn.classList.toggle('active', view === 'list');
    
    // Show/hide views
    mediaGrid.style.display = view === 'grid' ? 'grid' : 'none';
    mediaList.style.display = view === 'list' ? 'block' : 'none';
    
    renderImages();
  }

  function showImageDetails(imageId) {
    selectedImage = images.find(img => img.id === imageId);
    if (!selectedImage) return;
    
    // Populate details modal
    document.getElementById('preview-image').src = selectedImage.url;
    document.getElementById('detail-filename').value = selectedImage.filename;
    document.getElementById('detail-url').value = selectedImage.url;
    document.getElementById('detail-size').textContent = formatFileSize(selectedImage.size);
    document.getElementById('detail-date').textContent = formatDate(selectedImage.uploadDate);
    
    // Load image dimensions
    const img = new Image();
    img.onload = () => {
      document.getElementById('detail-dimensions').textContent = `${img.width} × ${img.height} px`;
    };
    img.src = selectedImage.url;
    
    detailsModal.classList.add('active');
  }

  async function deleteSelectedImage() {
    if (!selectedImage) return;
    
    if (!confirm(`Are you sure you want to delete "${selectedImage.name}"? This action cannot be undone.`)) {
      return;
    }
    
    try {
      const response = await fetch('/admin/api/delete-image.json', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          filename: selectedImage.filename
        })
      });
      
      if (response.ok) {
        detailsModal.classList.remove('active');
        loadImages(); // Refresh the list
        alert('Image deleted successfully');
      } else {
        const errorData = await response.json();
        alert(`Error deleting image: ${errorData.error}`);
      }
    } catch (error) {
      alert(`Error deleting image: ${error.message}`);
    }
  }

  function insertSelectedImage() {
    if (!selectedImage) return;
    
    // This would be used to insert into an editor if we're in that context
    // For now, just copy the URL
    copyToClipboard(selectedImage.url);
    detailsModal.classList.remove('active');
    alert('Image URL copied to clipboard');
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      // Show a temporary success message
      const btn = event.target.closest('button');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
      setTimeout(() => {
        btn.innerHTML = originalContent;
      }, 1000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard');
    });
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }
</script>