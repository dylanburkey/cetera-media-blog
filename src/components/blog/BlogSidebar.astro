---
export interface Props {
  class?: string;
}

// Fetch most viewed posts from database
let popularPosts = [];
let categories = [];
let tags = [];

try {
  // Try different ways to access the database
  const db = Astro.locals?.runtime?.env?.DB || 
             Astro.locals?.runtime?.env?.db ||
             Astro.locals?.env?.DB;
             
  if (db) {
    console.log('Database connection found');
    // Fetch popular posts (most viewed)
    const popularResult = await db.prepare(`
      SELECT 
        p.id,
        p.slug,
        p.title,
        p.cover_image,
        p.published_at,
        COALESCE(view_counts.views, 0) as views,
        0 as likes,
        (SELECT COUNT(*) FROM blog_comments WHERE post_id = p.id AND status = 'approved') as comment_count
      FROM blog_posts p
      LEFT JOIN (
        SELECT post_id, COUNT(*) as views
        FROM blog_views
        GROUP BY post_id
      ) view_counts ON p.id = view_counts.post_id
      WHERE p.status = 'published'
      ORDER BY views DESC
      LIMIT 3
    `).all();
    
    if (popularResult?.results && popularResult.results.length > 0) {
      popularPosts = popularResult.results.map(post => ({
        id: post.id,
        slug: post.slug,
        title: post.title,
        image: post.cover_image || '/img/blog/default-cover.jpg',
        date: new Date(post.published_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        comments: post.comment_count || 0,
        likes: post.likes || 0
      }));
    }
    
    // Fetch categories with counts
    const categoriesResult = await db.prepare(`
      SELECT 
        c.id,
        c.name,
        c.slug,
        (
          SELECT COUNT(DISTINCT pc.post_id)
          FROM blog_post_categories pc
          INNER JOIN blog_posts p ON pc.post_id = p.id
          WHERE pc.category_id = c.id AND p.status = 'published'
        ) as count
      FROM blog_categories c
      ORDER BY count DESC, c.name ASC
    `).all();
    
    if (categoriesResult?.results && categoriesResult.results.length > 0) {
      // Calculate total count from categories with posts
      const totalPosts = categoriesResult.results.reduce((sum, cat) => sum + (Number(cat.count) || 0), 0);
      
      // Build categories array
      const dbCategories = categoriesResult.results
        .filter(cat => Number(cat.count) > 0)
        .map(cat => ({
          name: cat.name,
          slug: cat.slug || cat.name.toLowerCase().replace(/\s+/g, '-'),
          count: Number(cat.count)
        }));
      
      categories = [
        { name: 'All topics', slug: 'all', count: totalPosts, active: true },
        ...dbCategories
      ];
    } else {
      // Fallback if no categories found
      categories = [
        { name: 'All topics', slug: 'all', count: 0, active: true }
      ];
    }
    
    // Fetch tags
    const tagsResult = await db.prepare(`
      SELECT DISTINCT t.name
      FROM blog_tags t
      INNER JOIN blog_post_tags pt ON t.id = pt.tag_id
      INNER JOIN blog_posts p ON pt.post_id = p.id AND p.status = 'published'
      ORDER BY t.name
      LIMIT 8
    `).all();
    
    if (tagsResult?.results && tagsResult.results.length > 0) {
      tags = tagsResult.results.map(tag => tag.name);
    }
  } else {
    console.log('No database connection found, using fallback data');
    // Set fallback data when no database connection
    categories = [
      { name: 'All topics', slug: 'all', count: 0, active: true },
      { name: 'News', slug: 'news', count: 0 },
      { name: 'Tutorials', slug: 'tutorials', count: 0 },
      { name: 'DeFi', slug: 'defi', count: 0 },
      { name: 'Technology', slug: 'technology', count: 0 }
    ];
    tags = ['Smart Money', 'AI Trading', 'DeFi', 'Blockchain', 'ATHENA Token'];
  }
} catch (err) {
  console.error('Error fetching sidebar data:', err);
  // Set full fallback data on error
  if (categories.length === 0) {
    categories = [
      { name: 'All topics', slug: 'all', count: 0, active: true },
      { name: 'News', slug: 'news', count: 0 },
      { name: 'Tutorials', slug: 'tutorials', count: 0 },
      { name: 'DeFi', slug: 'defi', count: 0 },
      { name: 'Technology', slug: 'technology', count: 0 }
    ];
  }
  if (tags.length === 0) {
    tags = ['Smart Money', 'AI Trading', 'DeFi', 'Blockchain', 'ATHENA Token'];
  }
}

// Ensure we have some tags if database is empty
if (tags.length === 0) {
  tags = ['Smart Money', 'AI Trading', 'DeFi', 'Blockchain', 'ATHENA Token'];
}

// Ensure we have at least the All topics category with proper slug
if (categories.length === 0) {
  categories = [
    { name: 'All topics', slug: 'all', count: 0, active: true },
    { name: 'News', slug: 'news', count: 0 },
    { name: 'Tutorials', slug: 'tutorials', count: 0 },
    { name: 'DeFi', slug: 'defi', count: 0 },
    { name: 'Technology', slug: 'technology', count: 0 }
  ];
}

const { class: className = '' } = Astro.props;
---

<aside class={`blog-sidebar ${className}`}>
  <!-- Search -->
  <div class="sidebar-widget">
    <h3 class="widget-title">Search</h3>
    <form class="search-form">
      <input 
        type="search" 
        placeholder="Search articles..." 
        class="search-input"
        aria-label="Search articles"
      />
      <button type="submit" class="search-btn" aria-label="Search">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
    </form>
  </div>

  <!-- Categories -->
  <div class="sidebar-widget">
    <h3 class="widget-title">Categories</h3>
    <ul class="categories-list">
      {categories.map((category) => (
        <li class={category.active ? 'active' : ''}>
          <a href={category.slug === 'all' ? '/blog' : `/blog/category/${category.slug}`}>
            <span class="category-name">{category.name}</span>
            <span class="category-count">{category.count}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>

  <!-- Popular Posts -->
  <div class="sidebar-widget">
    <h3 class="widget-title">Popular Posts</h3>
    <div class="popular-posts">
      {popularPosts.map((post) => (
        <article class="popular-post">
          <img src={post.image} alt={post.title} class="popular-post-image" />
          <div class="popular-post-content">
            <h4 class="popular-post-title">
              <a href={`/blog/${post.slug}`}>{post.title}</a>
            </h4>
            <div class="popular-post-meta">
              <span class="post-date">{post.date}</span>
              <div class="post-stats">
                <span class="stat-item">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                  </svg>
                  {post.comments}
                </span>
                <span class="stat-item">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                  </svg>
                  {post.likes}
                </span>
              </div>
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>

  <!-- Tags -->
  <div class="sidebar-widget">
    <h3 class="widget-title">Tags</h3>
    <div class="tags-cloud">
      {tags.map((tag) => (
        <a href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="tag-item">
          {tag}
        </a>
      ))}
    </div>
  </div>

  <!-- Newsletter -->
  <div class="sidebar-widget newsletter-widget">
    <h3 class="widget-title">Newsletter</h3>
    <p class="newsletter-text">Get weekly insights on smart money movements</p>
    <form class="newsletter-form">
      <input 
        type="email" 
        placeholder="Your email" 
        class="newsletter-input"
        required
      />
      <button type="submit" class="newsletter-btn">Subscribe</button>
    </form>
  </div>
</aside>

<style>
  .blog-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
  }

  .sidebar-widget {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .widget-title {
    font-size: var(--text-lg);
    font-weight: 700;
    margin-bottom: var(--space-lg);
    color: var(--color-text);
  }

  /* Search */
  .search-form {
    position: relative;
    display: flex;
  }

  .search-input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    padding-right: 48px;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-text);
    transition: all var(--transition-base);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-alpha-10);
  }

  .search-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-sm);
    color: white;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .search-btn:hover {
    background: var(--color-primary-dark);
  }

  /* Categories */
  .categories-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .categories-list li {
    border-bottom: 1px solid var(--color-border);
  }

  .categories-list li:last-child {
    border-bottom: none;
  }

  .categories-list a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) 0;
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-base);
  }

  .categories-list a:hover {
    color: var(--color-primary);
  }

  .categories-list li.active a {
    color: var(--color-primary);
    font-weight: 600;
  }

  .category-name {
    font-size: var(--text-sm);
  }

  .category-count {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    padding: 0 var(--space-xs);
    background: var(--color-background);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
  }

  .categories-list li.active .category-count {
    background: var(--color-primary-alpha-10);
    color: var(--color-primary);
  }

  /* Popular Posts */
  .popular-posts {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .popular-post {
    display: flex;
    gap: var(--space-md);
  }

  .popular-post-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: var(--radius-md);
    flex-shrink: 0;
  }

  .popular-post-content {
    flex: 1;
    min-width: 0;
  }

  .popular-post-title {
    font-size: var(--text-sm);
    font-weight: 600;
    margin-bottom: var(--space-xs);
    line-height: 1.4;
  }

  .popular-post-title a {
    color: var(--color-text);
    text-decoration: none;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color var(--transition-base);
  }

  .popular-post-title a:hover {
    color: var(--color-primary);
  }

  .popular-post-meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .post-date {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .post-stats {
    display: flex;
    gap: var(--space-md);
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .stat-item svg {
    opacity: 0.7;
  }

  /* Tags */
  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .tag-item {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-decoration: none;
    transition: all var(--transition-base);
  }

  .tag-item:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  /* Newsletter */
  .newsletter-widget {
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white;
  }

  .newsletter-widget .widget-title {
    color: white;
  }

  .newsletter-text {
    font-size: var(--text-sm);
    margin-bottom: var(--space-lg);
    color: white !important;
    opacity: 0.9;
  }

  .newsletter-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .newsletter-input {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-md);
    color: white;
    font-size: var(--text-sm);
    transition: all var(--transition-base);
  }

  .newsletter-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .newsletter-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .newsletter-btn {
    padding: var(--space-sm) var(--space-md);
    background: white;
    border: none;
    border-radius: var(--radius-md);
    color: var(--color-primary);
    font-size: var(--text-sm);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .newsletter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* Dark theme adjustments */
  [data-theme="dark"] .sidebar-widget {
    background: var(--color-surface);
  }

  [data-theme="dark"] .search-input {
    background: var(--color-surface-light);
  }

  [data-theme="dark"] .category-count {
    background: var(--color-surface-light);
  }

  [data-theme="dark"] .tag-item {
    background: var(--color-surface-light);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const newsletterForm = document.querySelector('.newsletter-form') as HTMLFormElement;
    
    if (newsletterForm) {
      newsletterForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const emailInput = newsletterForm.querySelector('.newsletter-input') as HTMLInputElement;
        const submitBtn = newsletterForm.querySelector('.newsletter-btn') as HTMLButtonElement;
        
        if (!emailInput || !submitBtn) return;
        
        const email = emailInput.value.trim();
        
        // Disable form during submission
        emailInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subscribing...';
        
        try {
          const response = await fetch('/api/newsletter/subscribe', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email,
              name: '',
              interests: ['blog_updates', 'smart_money']
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // Success
            emailInput.value = '';
            submitBtn.textContent = 'Subscribed!';
            submitBtn.style.background = 'var(--color-success)';
            
            setTimeout(() => {
              submitBtn.textContent = 'Subscribe';
              submitBtn.style.background = '';
              emailInput.disabled = false;
              submitBtn.disabled = false;
            }, 3000);
          } else {
            // Error
            alert(result.error || 'Failed to subscribe. Please try again.');
            emailInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Subscribe';
          }
        } catch (error) {
          console.error('Newsletter subscription error:', error);
          alert('An error occurred. Please try again later.');
          emailInput.disabled = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'Subscribe';
        }
      });
    }
  });
</script>